(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{208:function(t,s,e){"use strict";e.r(s);var n=e(0),a=Object(n.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),e("p",[t._v("一开始以为这个需求非常简单，就是在进入其他路由前，发送一下请求，杀死一下任务就好了。")]),t._v(" "),e("p",[t._v("然而现实狠狠的打了我的脸，因为退出页面的场景不止切换路由~")]),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),e("p",[t._v("在 chrome 下长这个样子，你们肯定都见过：")]),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17),t._m(18),t._v(" "),e("p",[t._v("以下行为是基于 chorme：")]),t._v(" "),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),t._m(22),t._v(" "),e("p",[t._v("现在大部分浏览器都不允许修改弹窗的标题，这个是为了安全考虑，来保证用户不受到错误信息的误导，")]),t._v(" "),t._m(23),t._v(" "),e("p",[t._v("一开始我以为既然可以拦截到用户的刷新/关闭页面的操作，出现了上面那个弹窗，这个需求就已经做完了的时候。")]),t._v(" "),t._m(24),t._v(" "),t._m(25),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),t._m(28),t._v(" "),e("p",[t._v("当页面正在被卸载的时候触发该事件，该事件不可取消，为不可逆操作。")]),t._v(" "),t._m(29),t._v(" "),e("p",[t._v("直接监听该事件就可以了。")]),t._v(" "),t._m(30),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),e("p",[t._v("到这里大家肯定以为已经做出来了该需求，事实上，并没有！")]),t._v(" "),t._m(34),t._v(" "),t._m(35),t._v(" "),t._m(36),t._v(" "),t._m(37),t._v(" "),e("p",[e("strong",[t._v("最后使用原生的"),e("a",{attrs:{href:"http://www.w3school.com.cn/xml/xml_http.asp",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest"),e("OutboundLink")],1),t._v("对象")]),t._v("，让请求同步")]),t._v(" "),t._m(38),t._v(" "),t._m(39),t._v(" "),e("p",[t._v("当我把这篇文章发布在公众号上，被"),e("a",{attrs:{href:"https://mp.weixin.qq.com/s/3taWHBu0vxRXP7WDax5M-Q",target:"_blank",rel:"noopener noreferrer"}},[t._v("奇舞周刊"),e("OutboundLink")],1),t._v("转载了，上面一些大佬给我提了一些建议。")]),t._v(" "),e("p",[t._v("研究了一下，结果...好吧！我承认我是菜鸡。")]),t._v(" "),e("p",[t._v("hey~ 不过这正是我写博客的收获之一，分享经验，收获知识！")]),t._v(" "),t._m(40),t._v(" "),t._m(41),t._v(" "),t._m(42),t._v(" "),t._m(43),t._v(" "),t._m(44),t._v(" "),t._m(45),t._v(" "),t._m(46),t._v(" "),t._m(47),t._v(" "),t._m(48),t._v(" "),t._m(49),t._v(" "),t._m(50),t._v(" "),t._m(51),t._m(52),t._v(" "),t._m(53),t._v(" "),t._m(54),t._v(" "),t._m(55),t._v(" "),t._m(56),t._v(" "),t._m(57),t._v(" "),t._m(58),t._m(59),t._v(" "),e("p",[t._v("浏览器支持：Edge：14+，Firefox：31+，Chrome：39+，Opera：26+，IE：不支持。")]),t._v(" "),t._m(60),t._v(" "),t._m(61),t._m(62),t._v(" "),t._m(63),t._v(" "),e("p",[t._v("这儿有一个MDN提供的"),e("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Beacon_API/Using_the_Beacon_API#WorkerNavigator.sendBeacon()",target:"_blank",rel:"noopener noreferrer"}},[t._v("栗子"),e("OutboundLink")],1),t._v("，可以点进去看一下。")]),t._v(" "),e("p",[t._v("PS：对web worker不熟悉的同学可以看我这篇"),e("a",{attrs:{href:"https://juejin.im/post/5bf8fa045188252f170e0dcb",target:"_blank",rel:"noopener noreferrer"}},[t._v("文章"),e("OutboundLink")],1)]),t._v(" "),t._m(64),t._v(" "),t._m(65),t._v(" "),t._m(66),t._v(" "),t._m(67),t._v(" "),e("p",[t._v("以上2019.02.19")]),t._v(" "),e("p",[e("a",{attrs:{href:"http://obkoro1.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("博客"),e("OutboundLink")],1),t._v("、"),e("a",{attrs:{href:"http://obkoro1.com/web_accumulate/accumulate/",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端积累文档"),e("OutboundLink")],1),t._v("、"),e("a",{attrs:{href:"https://github.com/OBKoro1/articleImg_src/blob/master/juejin/1631b6f52f7e7015.jpeg?raw=true",target:"_blank",rel:"noopener noreferrer"}},[t._v("公众号"),e("OutboundLink")],1),t._v("、"),e("a",{attrs:{href:"https://github.com/OBKoro1",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHub"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("参考资料：")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Beacon_API/Using_the_Beacon_API",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://www.barretlee.com/blog/2016/02/20/navigator-beacon-api/",target:"_blank",rel:"noopener noreferrer"}},[t._v("页面跳转时，统计数据丢失问题探讨"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.im/post/5b694b5de51d4519700fa56a#heading-4",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 Web Beacon API 记录活动"),e("OutboundLink")],1)]),t._v(" "),e("h3",{attrs:{id:"点个star支持我一下"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#点个star支持我一下"}},[t._v("#")]),t._v(" 点个"),e("a",{attrs:{href:"https://github.com/OBKoro1/web_accumulate",target:"_blank",rel:"noopener noreferrer"}},[t._v("Star"),e("OutboundLink")],1),t._v("支持我一下~")]),t._v(" "),e("comment-comment")],1)}),[function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"web-sendbeacon-刷新-关闭页面之前发送请求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#web-sendbeacon-刷新-关闭页面之前发送请求"}},[this._v("#")]),this._v(" Web sendBeacon 刷新/关闭页面之前发送请求")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"背景："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景："}},[this._v("#")]),this._v(" 背景：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("有一个任务非常耗时会消耗后台大量算力，所以在退出页面的时候，要求前端这边发送一个请求来杀死任务")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"退出页面场景："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#退出页面场景："}},[this._v("#")]),this._v(" 退出页面场景：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("还在本网站，跳到其他路由")]),this._v(" "),s("li",[s("strong",[this._v("刷新页面/关闭页面")]),this._v("也需要发送请求来杀死任务")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"还在本网站，跳到其他路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#还在本网站，跳到其他路由"}},[this._v("#")]),this._v(" 还在本网站，跳到其他路由")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个比较简单，在"),s("code",[this._v("Vue")]),this._v("中可以通过路由离开的钩子"),s("code",[this._v("beforeRouteLeave")]),this._v("来实现：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeRouteLeave")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" from"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("任务运行中"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送请求")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户离开")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("刷新页面/关闭页面的情况：")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("然而在刷新页面的时候，"),s("code",[this._v("beforeRouteLeave")]),this._v("并不会执行，接着想到了下面这两个"),s("code",[this._v("API")]),this._v(".")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"beforeunload和unload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beforeunload和unload"}},[this._v("#")]),this._v(" "),s("code",[this._v("beforeunload")]),this._v("和"),s("code",[this._v("unload")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"beforeunload-当浏览器窗口关闭或者刷新时触发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beforeunload-当浏览器窗口关闭或者刷新时触发"}},[this._v("#")]),this._v(" beforeunload 当浏览器窗口关闭或者刷新时触发:")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("介绍")]),this._v("：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用这个"),s("code",[this._v("API")]),this._v("可以阻止页面直接关闭，用户通过点击确定/取消按钮，来决定是否不关闭/刷新当前页面。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://github.com/OBKoro1/articleImg_src/blob/master/weibo_img_move/005Y4rCogy1g0bvkiozjwj30bt04vglt.jpg?raw=true",alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("如何使用")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个 API 的使用非常简单，只要在页面加载的时候监听一下此事件，在需要出现弹窗的时候"),s("strong",[this._v("return 一个可以转化为 true 的值")]),this._v(",就可以了。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 页面卸载之前")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否杀死任务")]),t._v("\nwindow"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onbeforeunload")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("任务运行 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" 对应页面"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'您可能有数据没有保存'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在部分浏览器可以修改弹窗标题")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 没有return一个可以转化为true的值 就不会出现弹窗")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("出现此弹窗的浏览器行为")]),this._v("：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ol",[e("li",[e("p",[t._v("焦点：你没有点击取消/确定之前，焦点会一直在此弹窗上")])]),t._v(" "),e("li",[e("p",[t._v("你无法在出现弹窗的页面上执行任何操作")])]),t._v(" "),e("li",[e("p",[t._v("在其他页面也只能执行简单的点击操作，弹窗还是存在页面中间，无法使用键盘，")])]),t._v(" "),e("li",[e("p",[t._v("键盘：键盘被绑定在弹窗上，只能通过按键"),e("code",[t._v("Esc")]),t._v("、"),e("code",[t._v("Enter")]),t._v("来执行取消/确定操作")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("弹窗不是页面的 dom，是浏览器的行为")])])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("用户取消/确定，没有回调 API，无法得知")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("弹窗标题")]),this._v("：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("chrome 中刷新页面的标题："),s("code",[this._v("重新加载此网站?")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("chrome 中关闭页面的标题："),s("code",[this._v("离开此网站?")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("迷茫")]),this._v("：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("然后发现，"),s("strong",[this._v("浏览器竟然没有提供用户点击确定/取消刷新页面的回调")]),this._v("。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("到这里我陷入了迷茫，盯着"),e("code",[t._v("beforeunload")]),t._v("这个 API 思考了起了人生的意义(其实是在发呆)，盯着盯着，从"),e("code",[t._v("beforeunload")]),t._v("的"),e("code",[t._v("before")]),t._v("我也就想到了"),e("code",[t._v("unload")]),t._v("这个 API。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("瞬间又燃起了斗志，何不试试这个"),s("code",[this._v("unload")]),this._v("？")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"unload当页面正在被卸载的时候触发该事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#unload当页面正在被卸载的时候触发该事件"}},[this._v("#")]),this._v(" "),s("code",[this._v("unload")]),this._v("当页面正在被卸载的时候触发该事件")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("介绍")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("使用")])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onunload")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("结合需求")]),this._v(":")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("killTask")]),this._v("为"),s("code",[this._v("beforeunload")]),this._v("时定义的变量，每次进入回调，都会给"),s("code",[this._v("killTask")]),this._v("赋值，使用这个值就可以判断什么时候可以发送请求杀死任务。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onunload")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" 对应页面"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送请求")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("无法发送异步请求")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我使用的是"),s("code",[this._v("axios")]),this._v("来发送请求，请求发出去了，但是被取消了，服务器那边根本没有收到请求，如下。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://github.com/OBKoro1/articleImg_src/blob/master/weibo_img_move/005Y4rCogy1g0bvl43w8gj31gd06n761.jpg?raw=true",alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("经过一顿分析:发现是"),s("code",[this._v("axios")]),this._v("请求是异步的问题，谷歌之后发现axios不支持同步的请求")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("s",[this._v("大功告成！")]),this._v(" 实际上，上面才是我第一次要发的内容，而下面更好的解决方法！")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"缺陷与更好的建议："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#缺陷与更好的建议："}},[this._v("#")]),this._v(" 缺陷与更好的建议：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"性能缺陷："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#性能缺陷："}},[this._v("#")]),this._v(" 性能缺陷：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("XHR同步请求会阻碍页面卸载，如果是刷新/跳转页面的话，"),s("strong",[this._v("页面重新展示速度会变慢，导致性能问题")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("毕竟"),s("strong",[this._v("向网络发送请求并获得响应可能会超级慢")]),this._v("，有可能是用户网络环境比较差，又或者是服务器挂了，请求一直没返回回来...")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("基于性能问题，大佬们推荐"),s("strong",[this._v("使用Beacon代替XHR")]),this._v("，然后经过一番搜索...")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"beacon-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beacon-api"}},[this._v("#")]),this._v(" Beacon API")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[s("strong",[this._v("Beacon API用于将少量数据通过post请求发送到服务器")]),this._v("。")]),this._v(" "),s("li",[s("strong",[s("code",[this._v("Beacon")]),this._v("是非阻塞请求，不需要响应")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"完美解决性能缺陷问题："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#完美解决性能缺陷问题："}},[this._v("#")]),this._v(" 完美解决性能缺陷问题：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[s("strong",[this._v("浏览器将 "),s("code",[this._v("Beacon")]),this._v(" 请求排队让它在空闲的时候执行并立即返回控制")])]),this._v(" "),s("li",[this._v("它在"),s("code",[this._v("unload")]),this._v("状态下也可以异步发送，不阻塞页面刷新/跳转等操作。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("所以**"),s("code",[this._v("Beacon")]),this._v("可以完美解决上面提到的因XHR同步请求阻塞而引起的性能缺陷问题**。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"使用：navigator-sendbeacon"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用：navigator-sendbeacon"}},[this._v("#")]),this._v(" 使用："),s("code",[this._v("navigator.sendBeacon()")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("完整API")]),this._v("：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" result "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" navigator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendBeacon")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("Beacon")]),this._v("是挂在"),s("code",[this._v("navigator")]),this._v("下面的，上面就是它的完整API。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("result")]),this._v("是一个布尔值，代表这次发送请求的结果:")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("如果浏览器接受并且把请求排队了则返回 tru")]),this._v(" "),s("li",[this._v("如果在这个过程中出现了问题就返回 false")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("navigator.sendBeacon")]),this._v("接受两个参数：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("url: 请求的 URL。请求是 POST 请求。")]),this._v(" "),s("li",[this._v("data: 要发送的数据。 数据类型可以是：ArrayBufferView, Blob,  FormData，Sting。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("来看一个用"),s("code",[this._v("FormData")]),this._v("来传递数据的栗子，你就懂了：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建一个新的 FormData 并添加一个键值对")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" data "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ndata"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'world'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" result "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" navigator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendBeacon")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./src'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n  console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'请求成功排队 等待执行'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'失败'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"浏览器支持："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#浏览器支持："}},[this._v("#")]),this._v(" 浏览器支持：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("虽然现在浏览器对"),s("code",[this._v("sendBeacon")]),this._v("的支持很好，我们对其做一下兼容性处理也是有必要的：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sendBeacon"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Beacon 代码")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 回退到 XHR同步请求或者不做处理")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"web-wroker中使用beacon"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#web-wroker中使用beacon"}},[this._v("#")]),this._v(" web wroker中使用Beacon")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("因为"),s("code",[this._v("Beacon")]),this._v("是挂在"),s("code",[this._v("navigator")]),this._v("下面，而web worker也有"),s("code",[this._v("navigator")]),this._v("，去找了一下，真的给我找到了。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"beacon其他相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beacon其他相关"}},[this._v("#")]),this._v(" Beacon其他相关")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[s("strong",[this._v("客户端优化：可以将 Beacon 请求合并到其他请求上，一同处理")]),this._v(", 尤其在移动环境下。")]),this._v(" "),s("li",[s("strong",[this._v("Beacon更多的情况是用于做前端埋点，监控用户活动")]),this._v("，它的初衷也基于此。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[this._v("#")]),this._v(" 小结")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("本文总共讲了三个API，"),e("code",[t._v("beforeunload")]),t._v("、"),e("code",[t._v("unload")]),t._v("和"),e("code",[t._v("Beacon")]),t._v("，"),e("code",[t._v("Beacon")]),t._v("这个API估计知道的人比较少，以后遇到前端埋点和页面卸载前发送请求的需求，记得使用这三个API。")])}],!1,null,null,null);s.default=a.exports}}]);